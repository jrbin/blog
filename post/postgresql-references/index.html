<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="generator" content="Hugo 0.27.1" />
    <meta name="description" content="Jrbin">
<meta name="author" content="Cooper">

    <link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
<link rel="icon" href="/images/favicon.png" type="image/x-icon" />

    <title>Postgresql References :: Jrbin</title>
    
    
    <link href="/blog/css/nucleus.css?1506607893" rel="stylesheet">
    <link href="/blog/css/font-awesome.min.css?1506607893" rel="stylesheet">
    <link href="/blog/css/hybrid.css?1506607893" rel="stylesheet">
    <link href="/blog/css/featherlight.min.css?1506607893" rel="stylesheet">
    <link href="/blog/css/perfect-scrollbar.min.css?1506607893" rel="stylesheet">
    <link href="/blog/css/horsey.css?1506607893" rel="stylesheet">
    <link href="/blog/css/theme.css?1506607893" rel="stylesheet">
    <link href="/blog/css/hugo-theme.css?1506607893" rel="stylesheet">
    

    <script src="/blog/js/jquery-2.x.min.js?1506607893"></script>
    
    <style type="text/css">
      :root #header + #content > #left > #rlblock_left{ 
          display:none !important;
      }
      
        :not(pre) > code + span.copy-to-clipboard {
            display: none;
        }
      
    </style>
    
  </head>
  <body class="" data-url="/blog/post/postgresql-references/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="/">JrBin
</a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fa fa-search"></i></label>
    <input data-search-input id="search-by" type="text" placeholder="Search...">
    <span data-search-clear=""><i class="fa fa-close"></i></span>
</div>

<script type="text/javascript" src="/blog/js/lunr.min.js?1506607893"></script>
<script type="text/javascript" src="/blog/js/horsey.js?1506607893"></script>
<script type="text/javascript">
    
        var baseurl = "https:\/\/jrbin.github.io\/blog\/";
    
</script>
<script type="text/javascript" src="/blog/js/search.js?1506607893"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          


 
  
    
    <li data-nav-id="/blog/stack/" title="Stack" class="dd-item 
        
        
        
        ">
      <a href="/blog/stack/">
          <b>1. </b>Stack
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/blog/stack/avoid-using-unsigned/" title="Avoid Using Unsigned" class="dd-item ">
        <a href="/blog/stack/avoid-using-unsigned/">
        Avoid Using Unsigned
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/stack/extra-empty-string-of-split/" title="Extra Empty String of Split" class="dd-item ">
        <a href="/blog/stack/extra-empty-string-of-split/">
        Extra Empty String of Split
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/stack/template-friend-function/" title="Template Friend Function" class="dd-item ">
        <a href="/blog/stack/template-friend-function/">
        Template Friend Function
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/blog/post/" title="Posts" class="dd-item 
        parent
        
        
        ">
      <a href="/blog/post/">
          <b>2. </b>Posts
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/blog/post/comp9024-graph-algo/" title="COMP9024 Graph Algorithm" class="dd-item ">
        <a href="/blog/post/comp9024-graph-algo/">
        COMP9024 Graph Algorithm
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/post/comp9024-midterm/" title="COMP9024 Midterm" class="dd-item ">
        <a href="/blog/post/comp9024-midterm/">
        COMP9024 Midterm
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/post/postgresql-references/" title="Postgresql References" class="dd-item active">
        <a href="/blog/post/postgresql-references/">
        Postgresql References
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/blog/cs9021/" title="9021" class="dd-item 
        
        
        
        ">
      <a href="/blog/cs9021/">
          <b>3. </b>9021
          
      </a>
      
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/blog/cs9311/" title="9311" class="dd-item 
        
        
        
        ">
      <a href="/blog/cs9311/">
          <b>4. </b>9311
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/blog/cs9311/postgresql-references/" title="Postgresql References" class="dd-item ">
        <a href="/blog/cs9311/postgresql-references/">
        Postgresql References
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/blog/cs9024/" title="9024" class="dd-item 
        
        
        
        ">
      <a href="/blog/cs9024/">
          <b>5. </b>9024
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/blog/cs9024/comp9024-graph-algo/" title="COMP9024 Graph Algorithm" class="dd-item ">
        <a href="/blog/cs9024/comp9024-graph-algo/">
        COMP9024 Graph Algorithm
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/cs9024/comp9024-midterm/" title="COMP9024 Midterm" class="dd-item ">
        <a href="/blog/cs9024/comp9024-midterm/">
        COMP9024 Midterm
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
         
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li class="" role=""> 
                  <a class="padding" href="https://github.com/jrbin/blog"><i class='fa fa-github'></i> Github repo</a>
              </li>
          
              <li class="" role=""> 
                  <a class="padding" href="https://jrbin.github.io/blog/showcase"><i class='fa fa-camera'></i> Showcases</a>
              </li>
          
              <li class="" role=""> 
                  <a class="padding" href="https://gohugo.io/"><i class='fa fa-bookmark'></i> Hugo Documentation</a>
              </li>
          
              <li class="" role=""> 
                  <a class="padding" href="https://jrbin.github.io/blog/credits"><i class='fa fa-bullhorn'></i> Credits</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="prefooter">
      <hr/>
      <ul>
       
      
      
      </ul>
    </section>
    
    <section id="footer">
      <p>Built with <a href="https://github.com/matcornic/hugo-theme-learn"><i class="fa fa-heart"></i></a> from <a href="http://getgrav.org">Grav</a> and <a href="http://gohugo.io/">Hugo</a></p>

    </section>
  </div>
</nav>





        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable sticky-parent">
              
              <div class="sticky-spacer">
                <div id="top-bar">
                
                  
                  
                  
                  <div id="top-github-link">
                    <a class="github-link" href="https://github.com/jrbin/blog/edit/master/content/post/postgresql-references.md" target="blank">
                      <i class="fa fa-code-fork"></i>
                      Edit this page
                    </a>
                  </div>
                  
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fa fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fa fa-list-alt"></i></span>
                  
                  <span class="links">
                    
          
          
            
            
          
          
            
            
          
          
            <a href='/blog/'>JrBin</a> > <a href='/blog/post/'>Posts</a> > Postgresql References
          
         
          
         
          
           
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
<ul>
<li><a href="#postgresql-references">Postgresql References</a>
<ul>
<li><a href="#constants">Constants</a></li>
<li><a href="#data-types">data types</a></li>
<li><a href="#date-time-functions">Date time functions</a></li>
<li><a href="#custom-functions">Custom functions</a>
<ul>
<li><a href="#return-setof">Return setof</a></li>
</ul></li>
<li><a href="#custom-aggregations">Custom aggregations</a></li>
<li><a href="#window-functions">Window functions</a></li>
<li><a href="#with-queries">With queries</a>
<ul>
<li><a href="#recursive-queries">Recursive queries</a></li>
<li><a href="#select-a-tree">Select a tree</a></li>
</ul></li>
<li><a href="#create-assertion">Create Assertion</a></li>
<li><a href="#joins">Joins</a>
<ul>
<li><a href="#cross-join">Cross join</a></li>
<li><a href="#inner-join">Inner join</a></li>
<li><a href="#left-outer-join">Left (outer) join</a></li>
<li><a href="#right-outer-join">Right (outer) join</a></li>
<li><a href="#full-outer-join">Full (outer) join</a></li>
</ul></li>
<li><a href="#transactions">Transactions</a></li>
<li><a href="#acid">ACID</a>
<ul>
<li><a href="#atomic">Atomic</a></li>
<li><a href="#consistency">Consistency</a></li>
<li><a href="#isolation">Isolation</a></li>
<li><a href="#durability">Durability</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            

        
        <div id="body-inner">
          
            <h1>Postgresql References</h1>
          

        



<h1 id="postgresql-references">Postgresql References</h1>

<h2 id="constants">Constants</h2>

<table>
<thead>
<tr>
<th>Type</th>
<th>Example</th>
<th>Note</th>
</tr>
</thead>

<tbody>
<tr>
<td>string</td>
<td>&lsquo;hello, world&rsquo;</td>
<td>不能用双引号</td>
</tr>

<tr>
<td>string with escape</td>
<td>E&rsquo;hello, world\n&rsquo;</td>
<td>&lsquo;\n&rsquo;会被当作换行输出，跟C语言中字符串类似</td>
</tr>

<tr>
<td>multiline string</td>
<td>$$abc$$</td>
<td>$$中间可以有字符，比如$func$abc$func$</td>
</tr>

<tr>
<td>boolean</td>
<td>true, false</td>
<td></td>
</tr>

<tr>
<td>numeric</td>
<td>12.34</td>
<td>没有单引号以及不是boolean的都被视为numeric</td>
</tr>
</tbody>
</table>

<p>双引号作为escape关键词的手段要少用（即尽量不要用关键词作为identifier）（而且双引号可以指定有大写字母的identifier，正常来说SQL的identifier是大小写不分的）</p>

<p>例如</p>

<pre><code class="language-sql">create table &quot;table&quot;();  -- 可行的但不建议
create table &quot;Table&quot;();  -- 可行的但不建议
</code></pre>

<p>其他类型</p>

<pre><code class="language-sql">type 'string'
'string'::type
CAST ( 'string' AS type )

-- 例如
date '2015-01-01'
12.34::float
</code></pre>

<h2 id="data-types">data types</h2>

<p>除注明外，以下类型均是SQL标准支持，在定义table时，尽量使用SQL标准的类型。</p>

<table>
<thead>
<tr>
<th>Name</th>
<th>Aliases</th>
<th>Note</th>
</tr>
</thead>

<tbody>
<tr>
<td>integer</td>
<td>int, int4</td>
<td></td>
</tr>

<tr>
<td>smallint</td>
<td>int2</td>
<td></td>
</tr>

<tr>
<td>bigint</td>
<td>int8</td>
<td></td>
</tr>

<tr>
<td>boolean</td>
<td>bool</td>
<td></td>
</tr>

<tr>
<td>character (n)</td>
<td>char (n)</td>
<td></td>
</tr>

<tr>
<td>character varying (n)</td>
<td>varchar (n)</td>
<td></td>
</tr>

<tr>
<td>double precision</td>
<td>float, float8</td>
<td></td>
</tr>

<tr>
<td>real</td>
<td>float4</td>
<td></td>
</tr>

<tr>
<td>numeric (p, s)</td>
<td>decimal (p, s)</td>
<td>p：总位数，s：小数点右边位数</td>
</tr>

<tr>
<td>date</td>
<td></td>
<td></td>
</tr>

<tr>
<td>time [ without time zone ]</td>
<td></td>
<td></td>
</tr>

<tr>
<td>time with time zone</td>
<td>timetz</td>
<td></td>
</tr>

<tr>
<td>timestamp [ without time zone ]</td>
<td></td>
<td></td>
</tr>

<tr>
<td>timestamp with time zone</td>
<td>timestamptz</td>
<td></td>
</tr>

<tr>
<td>serial</td>
<td>serial4</td>
<td>自增整数，非标准SQL</td>
</tr>

<tr>
<td>smallserial</td>
<td>serial2</td>
<td>自增整数，非标准SQL</td>
</tr>

<tr>
<td>bigserial</td>
<td>serial8</td>
<td>自增整数，非标准SQL</td>
</tr>
</tbody>
</table>

<h2 id="date-time-functions">Date time functions</h2>

<table>
<thead>
<tr>
<th>Function</th>
<th>Returns</th>
<th>Example</th>
<th>Result</th>
</tr>
</thead>

<tbody>
<tr>
<td>current_date</td>
<td>date</td>
<td></td>
<td></td>
</tr>

<tr>
<td>current_time</td>
<td>timetz</td>
<td></td>
<td></td>
</tr>

<tr>
<td>current_timestamp</td>
<td>timestamptz</td>
<td></td>
<td>2017-09-13 13:32:03.234753+10</td>
</tr>

<tr>
<td>localtime</td>
<td>time</td>
<td></td>
<td></td>
</tr>

<tr>
<td>localtimestamp</td>
<td>timestamptz</td>
<td></td>
<td>2017-09-13 13:32:03.234753</td>
</tr>

<tr>
<td>now()</td>
<td>timestamptz</td>
<td></td>
<td>2017-09-13 13:32:03.234753+10</td>
</tr>

<tr>
<td>timeofday()</td>
<td>text</td>
<td></td>
<td>Wed Sep 13 13:31:49.227326 2017 AEST</td>
</tr>

<tr>
<td>date_part(text, timestamp)</td>
<td>float</td>
<td>date_part(&lsquo;hour&rsquo;, timestamp &lsquo;2001-02-16 20:38:40&rsquo;)</td>
<td>20</td>
</tr>

<tr>
<td>extract(field from timestamp)</td>
<td>float</td>
<td>extract(hour from timestamp &lsquo;2001-02-16 20:38:40&rsquo;)</td>
<td>20</td>
</tr>
</tbody>
</table>

<h2 id="custom-functions">Custom functions</h2>

<pre><code class="language-sql">create or replacce function
f(arg1 type1, arg2 type2) returns type
as $$
... function body ...
$$ language language [ mode ];
</code></pre>

<p>mode可能的值为</p>

<ul>
<li>immutable: 不访问数据库 (fast)</li>
<li>stable: 不修改数据库</li>
<li>volatile: 修改数据库 (slow, default)</li>
</ul>

<p>在语言为sql的时候只能通过$1, $2等访问参数。语言为plpgsql的时候可以通过参数名访问，也可以通过$1, $2访问，最好用一个下划线前缀如<code>_name</code>当作参数名避免冲突。</p>

<p>plpgsql时函数体如</p>

<pre><code class="language-sql">create or replacce function
f(arg1 type1, arg2 type2) returns text
as $$
declare
    r       record;
    out     text := '';
    curbeer text := '';
    tasters text;
    sum     int;
    count   int;
begin
    for r in
        select * from AllRatings order by beer,taster
    loop
        if (r.beer &lt;&gt; curbeer) then
            if (curbeer &lt;&gt; '') then
                out := out || BeerDisplay(curbeer,sum/count,tasters);
            end if;
            curbeer := r.beer;
            sum := 0; count := 0; tasters := '';
        end if;
        sum := sum + r.rating;
        count := count + 1;
        tasters := tasters || ', ' || r.taster;
    end loop;
    -- finish off the last beer
    out := out || beerDisplay(curbeer,sum/count,tasters);
    return out;
end;
$$ language plpgsql;
</code></pre>

<p>declare与begin后都不加分号，end可加可不加。另外每个赋值语句也要加分号。control structure（如for, if）在没有end之前那些关键词都不加分号。（但其中的赋值语句要）</p>

<h3 id="return-setof">Return setof</h3>

<pre><code class="language-sql">returns setof text
returns setof table(x int, y int) -- temporary table as type
create type pair as (x int, y int);
returns setof pair
--
return setof record -- avoid that
-- you will need a column definition list every time you call the function
-- as follows
select * from func() as f(x int, y varchar(30));
</code></pre>

<p>returns setof的函数中return也有所不同</p>

<pre><code>RETURN NEXT expression;
RETURN QUERY query;
RETURN QUERY EXECUTE command-string;
</code></pre>

<p><code>RETURN NEXT</code>可用于for循环中，比如</p>

<pre><code>for r in
    select * from beer
loop
    return next r;
end loop;
</code></pre>

<p>它只是每一次都把一行的结果加到return的set中。</p>

<p><code>RETURN QUERY</code>后面跟一个正常的query，<code>RETURN QUERY EXECUTE</code>后面则跟的是query的字符串。</p>

<h2 id="custom-aggregations">Custom aggregations</h2>

<p>postgresql处理aggregate是如下的伪代码</p>

<pre><code>state = initial state
for each item in group {
    state = sfunc(state, item)
}
return finalfunc(AggState)
</code></pre>

<p>比如avg的伪代码可以写成这样</p>

<pre><code>state = (0, 0)
for each value in group {
    state = (state.x + value, state.y + 1)
}
return state.x / state.y
</code></pre>

<p>具体在postgresql中是这样定义的</p>

<pre><code class="language-sql">create aggregate concat_with_comma (text) (
    stype     = text,
    initcond  = '',
    sfunc     = appendNext,
    finalfunc = finalText
);
</code></pre>

<p>其中，concat_with_comma是aggregation的函数名（比如内置的min，max），括号中的text是参数类型。stype是state的类型，initcond是state的初始值。sfunc和finalfunc都对应上面伪代码的位置，并且都是postgresql中的function。</p>

<h2 id="window-functions">Window functions</h2>

<p>是可以在某列上计算aggregate function（如min，max，avg）但又不group by。如下。</p>

<pre><code class="language-sql">select round(avg(rating) over (partition by taster), 2), *
from allratings;
</code></pre>

<pre><code> round | taster |          beer          |          brewer          | rating
-------+--------+------------------------+--------------------------+--------
  2.00 | Adam   | Old                    | Toohey's                 |      4
  2.00 | Adam   | Victoria Bitter        | Carlton and United       |      1
  2.00 | Adam   | New                    | Toohey's                 |      1
  3.67 | Geoff  | Redback                | Matilda Bay Brewing      |      4
  3.67 | Geoff  | James Squire Pilsener  | Maltshovel Brewery       |      4
  3.67 | Geoff  | Empire                 | Carlton and United       |      3
  3.50 | Hector | Pale Ale               | Sierra Nevada            |      4
  3.50 | Hector | Fosters                | Carlton and United       |      3
</code></pre>

<p>group by的结果是。而且注意group by是没法select没有被group by或者aggregate的列的，比如beer和brewer。</p>

<pre><code> round | taster
-------+--------
  2.00 | Adam
  3.67 | Geoff
  3.50 | Hector
</code></pre>

<h2 id="with-queries">With queries</h2>

<p>会生成temporary tables供with语句后的语句使用。比如</p>

<pre><code class="language-sql">WITH regional_sales AS (
        SELECT region, SUM(amount) AS total_sales
        FROM orders
        GROUP BY region
     ), top_regions AS (
        SELECT region
        FROM regional_sales
        WHERE total_sales &gt; (SELECT SUM(total_sales)/10 FROM regional_sales)
     )
SELECT region,
       product,
       SUM(quantity) AS product_units,
       SUM(amount) AS product_sales
FROM orders
WHERE region IN (SELECT region FROM top_regions)
GROUP BY region, product;
</code></pre>

<h3 id="recursive-queries">Recursive queries</h3>

<p>With语句另外一个非常有用的地方在于它能够递归地查询，例如</p>

<pre><code class="language-sql">WITH RECURSIVE t(n) AS (
    VALUES (1)
  UNION ALL
    SELECT n+1 FROM t WHERE n &lt; 100
)
SELECT sum(n) FROM t;
</code></pre>

<p>定义与view类似，t是表名，n是列名。</p>

<p>union all前的是初始条件，这里是n这列初始化为1的意思，当然也可以写成<code>select 1</code>。</p>

<p>union all后面是recursive的部分，需要引用到t（要不然就不递归了）。递归部分的表t都是上一次产生的结果。比如说第一次执行的是<code>VALUES(1)</code>，第二次执行<code>SELECT n+1 FROM t WHERE n &lt; 100</code>的时候t里就有一个元素是1，这次的执行结果产生一个值2，这个值作为下一次表t的值。</p>

<h3 id="select-a-tree">Select a tree</h3>

<p>再看一个实际一点的例子，我们有一个表存了一棵多叉树。是以parent指针这种方式存的。这种存法的好处是表非常简单，插入修改什么的都很方便。但其中有个问题是怎样算出每个节点到根的深度，或者这个表里有多棵树的话，怎么把单独的一棵树用一个query就查出来。</p>

<p>假设我们有这样一棵树。</p>

<p><img alt='binary tree' src='/img/tree.png' width=200></p>

<p>在数据库它的表示是</p>

<pre><code class="language-sql">create table tree_node (
    id int primary key,
    parent_id int references tree_node(id)
);
</code></pre>

<pre><code> id | parent_id
----+-----------
  1 |
  2 |         1
  3 |         1
  4 |         2
  5 |         2
  6 |         3
  7 |         3
</code></pre>

<p>那么，从根（即id为1的点）把整棵树都拎出来并且顺便算出每个节点的深度的SQL如下。</p>

<pre><code class="language-sql">with recursive children(id, parent_id, depth) as (
    select 1, null::int, 0
union all
    select t.id, t.parent_id, c.depth + 1
    from children c
    join tree_node t on c.id = t.parent_id
)
select * from children;
</code></pre>

<p>它从根开始，每次查到下一层的所有节点，并把深度加1。最后，叶子结点没有children，所以用inner join后select会return空集，所以到叶子结点后就会停止。结果如下</p>

<pre><code> id | parent_id | depth
----+-----------+-------
  1 |           |     0
  2 |         1 |     1
  3 |         1 |     1
  4 |         2 |     2
  5 |         2 |     2
  6 |         3 |     2
  7 |         3 |     2
</code></pre>

<h2 id="create-assertion">Create Assertion</h2>

<p>constraint需要依赖于某一特定的table，而且语法非常简单。</p>

<h2 id="joins">Joins</h2>

<pre><code class="language-sql">CREATE TABLE weather (
    city        varchar(80),
    temp_lo        int,        -- low temperature
    temp_hi        int,        -- high temperature
    prcp        real,        -- precipitation
    date        date
);

CREATE TABLE cities (
    name        varchar(80),
    location    point
);
</code></pre>

<p>这里的命名就是一个不好的例子。</p>

<pre><code>     city      | temp_lo | temp_hi | prcp |    date
---------------+---------+---------+------+------------
 San Francisco |      46 |      50 | 0.25 | 1994-11-27
 San Francisco |      43 |      57 |    0 | 1994-11-29
 Hayward       |      37 |      54 |      | 1994-11-29

     name      | location
---------------+-----------
 San Francisco | (-194,53)
 Houston       | (-183,25)
</code></pre>

<h3 id="cross-join">Cross join</h3>

<pre><code class="language-sql">SELECT w.city as weather_city, w.temp_lo, c.name as city_name, c.location
FROM weather w, cities c;
</code></pre>

<pre><code> weather_city  | temp_lo |   city_name   | location
---------------+---------+---------------+-----------
 San Francisco |      46 | San Francisco | (-194,53)
 San Francisco |      46 | Houston       | (-183,25)
 San Francisco |      43 | San Francisco | (-194,53)
 San Francisco |      43 | Houston       | (-183,25)
 Hayward       |      37 | San Francisco | (-194,53)
 Hayward       |      37 | Houston       | (-183,25)
</code></pre>

<p>相当于笛卡尔乘积，表A中所有可能值组合表B中所有可能值，结果条数为N * M。不常用，即使加上where条件，速度慢。</p>

<h3 id="inner-join">Inner join</h3>

<pre><code class="language-sql">SELECT w.city as weather_city, w.temp_lo, c.name as city_name, c.location
FROM weather w
JOIN cities c on w.city = c.name;
</code></pre>

<pre><code> weather_city  | temp_lo |   city_name   | location
---------------+---------+---------------+-----------
 San Francisco |      46 | San Francisco | (-194,53)
 San Francisco |      43 | San Francisco | (-194,53)
</code></pre>

<p>只会出现key（即join的那一列）值分别都存在于两表的行，比如San Francisco都在weather和cities两表中。而Hayward只在weather中，而不在cities中，所以join之后就不出现了。Houston同理。</p>

<h3 id="left-outer-join">Left (outer) join</h3>

<pre><code class="language-sql">SELECT w.city as weather_city, w.temp_lo, c.name as city_name, c.location
FROM weather w
LEFT JOIN cities c on w.city = c.name;
</code></pre>

<pre><code> weather_city  | temp_lo |   city_name   | location
---------------+---------+---------------+-----------
 San Francisco |      46 | San Francisco | (-194,53)
 San Francisco |      43 | San Francisco | (-194,53)
 Hayward       |      37 |               |
</code></pre>

<p>出现在左边表的key值都会出现在结果中，如果它不在右边表中，结果表中对应右边表的列都为null。比如Hayward那一行。</p>

<h3 id="right-outer-join">Right (outer) join</h3>

<pre><code>weather_city  | temp_lo |   city_name   | location
---------------+---------+---------------+-----------
San Francisco |      43 | San Francisco | (-194,53)
San Francisco |      46 | San Francisco | (-194,53)
              |         | Houston       | (-183,25)
</code></pre>

<h3 id="full-outer-join">Full (outer) join</h3>

<pre><code> weather_city  | temp_lo |   city_name   | location
---------------+---------+---------------+-----------
 San Francisco |      46 | San Francisco | (-194,53)
 San Francisco |      43 | San Francisco | (-194,53)
 Hayward       |      37 |               |
               |         | Houston       | (-183,25)
</code></pre>

<p>Inner join与Left join较常用，看具体需要。</p>

<h2 id="transactions">Transactions</h2>

<p>是一系列语句的集合，它们要么同时被成功执行，要么都没有被执行（比如其中一句执行出错了，前面成功的结果也不会写到数据库中）。</p>

<p>设想一个转账的情景。A给B转100元，A账户里要扣100元，B账户里加100元。如果A账户扣成功了，但B账户收钱时发生错误了没有加上100元。我们不希望这样的情况发生。所以希望当中间发生错误了，A的100元也不会被扣掉。</p>

<p>在transaction中，已经执行的操作在commit前对其他transactions都是不可见的。事实上，在postgresql中，每一个单独的语句都被作为是一个transaction来执行。而多语句的transaction以以下的语法实现。</p>

<pre><code class="language-sql">BEGIN;
UPDATE accounts SET balance = balance - 100.00
    WHERE name = 'Alice';
UPDATE branches SET balance = balance - 100.00
    WHERE name = (SELECT branch_name FROM accounts WHERE name = 'Alice');
UPDATE accounts SET balance = balance + 100.00
    WHERE name = 'Bob';
UPDATE branches SET balance = balance + 100.00
    WHERE name = (SELECT branch_name FROM accounts WHERE name = 'Bob');
COMMIT;
</code></pre>

<h2 id="acid">ACID</h2>

<h3 id="atomic">Atomic</h3>

<p>原子性，被transaction这个机制实现的</p>

<h3 id="consistency">Consistency</h3>

<p>一致性，数据与DDL描述的是一致的，constraints比如foreign key都是不能违反的。</p>

<h3 id="isolation">Isolation</h3>

<p>隔离性，即在transaction中，已经执行的操作在commit前对其他transactions都是不可见的。</p>

<h3 id="durability">Durability</h3>

<p>持久性，即transaction完成后，所有的变化都应该被保存在持久的介质上（如硬盘，而不是内存）</p>


<footer class=" footline" >
	
</footer>


        
        </div> 
      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
        
        


        
            <a class="nav nav-prev" href="/blog/post/comp9024-midterm/" title="COMP9024 Midterm"> <i class="fa fa-chevron-left"></i></a>
        
        
            <a class="nav nav-next" href="/blog/cs9021/" title="9021" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
        
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/blog/js/clipboard.min.js?1506607893"></script>
    <script src="/blog/js/perfect-scrollbar.min.js?1506607893"></script>
    <script src="/blog/js/perfect-scrollbar.jquery.min.js?1506607893"></script>
    <script src="/blog/js/jquery.sticky-kit.min.js?1506607893"></script>
    <script src="/blog/js/featherlight.min.js?1506607893"></script>
    <script src="/blog/js/html5shiv-printshiv.min.js?1506607893"></script>
    <script src="/blog/js/highlight.pack.js?1506607893"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/blog/js/modernizr.custom.71422.js?1506607893"></script>
    <script src="/blog/js/learn.js?1506607893"></script>
    <script src="/blog/js/hugo-learn.js?1506607893"></script>

    <link href="/blog/mermaid/mermaid.css?1506607893" type="text/css" rel="stylesheet" />
    <script src="/blog/mermaid/mermaid.js?1506607893"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    

  </body>
</html>

